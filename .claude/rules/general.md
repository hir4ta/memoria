# グローバルルール

このルールはプロジェクト全体に常時適用されます。

## ドキュメント確認（重要）

### 要件・設計の確認タイミング

**以下のタイミングで必ず `docs/plans/` 配下を確認すること：**

- 新しい機能の実装開始前
- 実装方針に迷った時
- データ構造を変更する時
- API設計を行う時

| ファイル | 確認すべき時 |
|---------|-------------|
| `requirements.md` | 機能要件の確認、優先度の確認 |
| `design.md` | アーキテクチャ、データ構造、API仕様 |
| `tasks.md` | 実装順序、依存関係 |

### tasks.md の更新ルール

**タスク管理を正確に行うため、以下を厳守：**

```
開始時: [ ] → [x] に変更、または「作業中」マーク追加
完了時: 完了マーク、必要に応じて備考追加
```

- タスク開始時に必ず tasks.md を更新
- タスク完了時に必ず tasks.md を更新
- 予期せぬサブタスクが発生した場合は追記
- 実装中に仕様変更があれば design.md も更新

### 公式ドキュメントリサーチ（必須）

**新規実装時や実装に迷った時は、必ず公式ドキュメントをリサーチして最新のベストプラクティスを確認すること。**

```
実装前のリサーチフロー:
1. 公式ドキュメントを WebFetch / WebSearch で確認
2. 最新のベストプラクティスを把握
3. 古い書き方や非推奨パターンを避ける
4. 実装に反映
```

以下の場合は特にリサーチ必須：
- Next.js 16 / React 19 の新機能・パターン
- shadcn/ui コンポーネントの使い方
- Tailwind CSS v4 の構文
- Zod バリデーションパターン
- MCP SDK の API
- Server Components / Server Actions の実装

### Context7 による最新ドキュメント確認

**Context7 が利用可能な場合は積極的に活用すること。**

```
「use context7」をプロンプトに追加して最新の公式ドキュメントを取得
```

## コード品質

### 命名規則

- **変数・関数**: camelCase（`getUserById`, `isValid`）
- **型・クラス**: PascalCase（`UserProfile`, `ApiResponse`）
- **定数**: UPPER_SNAKE_CASE（`MAX_RETRY_COUNT`）
- **ファイル**: kebab-case（`user-profile.ts`）
- **コンポーネント**: PascalCase（`SessionCard.tsx`）

### インポート順序

1. 外部ライブラリ（React, Next.js など）
2. 内部モジュール（`@/lib`, `@/components`）
3. 相対インポート（`./`, `../`）

### エラーハンドリング

- 外部境界（API、ユーザー入力）でのみバリデーション
- 内部コードは信頼し、過剰な防御的プログラミングを避ける
- Zod スキーマで境界バリデーション

## Git コミット

- 1コミット = 1つの論理的変更
- コミットメッセージは変更の「なぜ」を説明
- Conventional Commits 形式推奨（`feat:`, `fix:`, `refactor:`）

## セキュリティ

- ハードコードされたシークレット禁止
- 環境変数を使用
- `.env` ファイルはコミットしない

## ドキュメント

- 公開 API のみ JSDoc を記述
- 自明なコードにコメントは不要
- コメントは「なぜ」を説明（「何を」はコードで表現）

## memoria 固有ルール

### データ構造変更

`.memoria/` のスキーマを変更する場合：
1. `design.md` のデータ構造セクションを先に更新
2. Zod スキーマを更新
3. 既存データのマイグレーション方針を検討

### MCP ツール追加

新しい MCP ツールを追加する場合：
1. `design.md` の MCP ツール表を更新
2. 入力スキーマを Zod で定義
3. エラーレスポンスを統一フォーマットで返す

## コードレビュー（Codex MCP）

### 実装完了後のレビュー

**機能実装が完了したら、Codex MCP を使ってコードレビューを実施すること。**

```
レビューフロー:
1. 実装完了
2. Codex MCP でレビュー依頼
3. 指摘事項を確認
4. 議論・検討（下記参照）
5. 必要な修正を実施
```

### Codex MCP との議論（重要）

**Codex MCP の意見を鵜呑みにしない。**

Claude Code として独自の考えがある場合：
- Codex MCP の指摘に対して反論・議論する
- 両者の意見を比較検討する
- 最適な修正方針を導き出す
- 根拠のある判断を行う

```
議論のポイント:
- 「なぜその修正が必要か」を確認
- プロジェクトの文脈に合っているか検討
- パフォーマンス、可読性、保守性のバランス
- 過剰な修正になっていないか確認
```

Codex MCP が正しい場合は素直に修正し、Claude Code の判断が正しい場合はその旨を説明して修正しない選択も可。
